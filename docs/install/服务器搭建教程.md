# HuLa-Server 零基础完整部署教程

## 1. 准备工作

### 1.1 安装 Docker

```bash
# 1. 更新系统
sudo yum update -y

# 2. 安装依赖
sudo yum install -y yum-utils device-mapper-persistent-data lvm2

# 3. 添加Docker仓库
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 4. 安装Docker
sudo yum install -y docker-ce docker-ce-cli containerd.io

# 5. 启动Docker
sudo systemctl start docker
sudo systemctl enable docker

# 6. 验证安装
docker --version
# 输出类似: Docker version 24.0.7, build afdd53b
```

### 1.2 安装 Docker Compose

```bash
# 1. 下载Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# 2. 添加执行权限
sudo chmod +x /usr/local/bin/docker-compose

# 3. 验证安装
docker-compose --version
# 输出类似: Docker Compose version v2.24.0
```

### 1.3 安装 JDK 21

```bash
# 1. 下载JDK 21
cd /opt
wget https://download.oracle.com/java/21/latest/jdk-21_linux-x64_bin.tar.gz

# 2. 解压
tar -xzf jdk-21_linux-x64_bin.tar.gz

# 3. 配置环境变量
echo 'export JAVA_HOME=/opt/jdk-21.0.5' >> ~/.bashrc
echo 'export PATH=$JAVA_HOME/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 4. 验证安装
java -version
# 输出类似: java version "21.0.5" 2024-10-15 LTS
```

### 1.4 安装 Maven

```bash
# 1. 下载Maven
cd /opt
wget https://dlcdn.apache.org/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz

# 2. 解压
tar -xzf apache-maven-3.9.6-bin.tar.gz

# 3. 配置环境变量
echo 'export MAVEN_HOME=/opt/apache-maven-3.9.6' >> ~/.bashrc
echo 'export PATH=$MAVEN_HOME/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 4. 验证安装
mvn -version
```

### 1.5 安装 Git

```bash
sudo yum install -y git
git --version
```

### 1.6 克隆 HuLa-Server 仓库

```bash
cd /home
git clone https://github.com/HuLaSpark/HuLa-Server.git
```

### 2. 准备路径

```bash
上传或复制/HuLa-Server/docs/install/目录下的docker文件夹到服务器/home/docker下面.

#创建必要目录
mkdir /home/docker/rocketmq/broker/conf/ /home/docker/rocketmq/ broker/logs/ /home/docker/rocketmq/broker/store/ /home/rocketmq/store/ -p
chmod 777 /home/docker/rocketmq/broker/conf/
chmod 777 /home/docker/rocketmq/broker/logs/
chmod 777 /home/docker/rocketmq/broker/store/
chmod 777 /home/docker/rocketmq/timerwheel/
```

确保目录和权限正确。，具体目录需要和 docker-compose.yml 中的 volume 配置对应，尤其是 rocketmq-broker 这个容器的配置。

### 3.准备 mysql 文件

```bash
上传或复制/HuLa-Server/docs/install/目录下的sql文件以及文件夹到服务器/home/docker下面.
其中 mysql-schema.SQL 是数据库初始化脚本，对应数据库名nacos，后续需要导入。
```

## 2. 修复完善配置

### 2.1 修改 RocketMQ 配置

```bash
修改 docs\install\docker\rocketmq\broker\conf\broker.conf 文件里的 brokerIP1 的值，改成服务器的实际 IP 地址。
同时需要检查目录
# 存储配置
storePathRootDir=/home/rocketmq/store
storePathCommitLog=/home/rocketmq/store/commitlog
storePathConsumeQueue=/home/rocketmq/store/consumequeue
storePathIndex=/home/rocketmq/store/index
storeCheckpoint=/home/rocketmq/store/checkpoint
abortFile=/home/rocketmq/store/abort
不存在则需要创建，并赋予读写权限。
```

### 2.2 修改 srs 配置

定位文件到 docs\install\docker\srs\srs_conf_7088.conf

```bash
修改 docs\install\docker\srs\srs_conf_7088.conf 文件里的 candidate 的值，改成服务器的实际 IP 地址。
```

## 3.确保上述都配置完成后，执行下面命令启动 mysql

```bash
cd /home/docker
docker-compose up -d mysql
```

## 4.导入数据库

```bash
#需要先启动mysql
cd /home/docker
docker-compose up -d mysql
#需要导入的数据库有
mysql-schema.SQL，luohuo_dev.sql,luohuo_im_01.sql,
#例如：
docker-compose exec mysql mysql -uroot -p123456 nacos < /home/docker/mysql-schema.SQL
#其余剩余两个数据库导入方式类似，数据库名和文件名对应即可。
```

部分步骤可以参考[docs/install/docker/reids、mysql、rocketmq、nacos 一键部署.md](.\docker\reids、mysql、rocketmq、nacos一键部署.md)

## 5.启动服务

当 mysql 成功运行并导入数据库后，启动服务

```bash
cd /home/docker
docker-compose up -d
```

## 6. 验证服务是否正常运行

```bash
# 1. 验证服务是否正常运行
docker ps
# 输出类似:
# CONTAINER ID   IMAGE                    COMMAND                  CREATED         STATUS         PORTS                                       NAMES
# 8a3d9a7a057d   nacos/nacos-server:2.0.3   "/bin/sh -c 'sh /na…"   2 minutes ago   Up 2 minutes   0.0.0.0:8848->8848/tcp, :::8848->8848/tcp   nacos-server
```

其中,minio-mc 容器不是常驻进程，启动成功后会自动退出。

## 7.最后 docker 查看所有容器状态，

确保除了 minio-mc 之外，所有容器都处于 Up 状态。

## 8.进入 nacos 网页控制台，

```bash
地址: http://IP:8080/nacos
用户名密码可查看.env文件，默认都是 nacos
```

**然后导入 nacos 命名空间数据**: [nacos_config.zip](nacos_config.zip)

## 综上，服务器地基部分基本搭建完毕
